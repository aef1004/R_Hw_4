---
title: "Hw4"
author: "Amy Fox"
date: "October 24, 2018"
output: word_document
---

```{r}
knitr::opts_chunk$set(message = FALSE)
```

Load necessary packages
```{r}
library(readr)
library(tidyr)
library(dplyr)
library(forcats)
library(broom)
library(purrr)
library(ggplot2)

```

Read in homicide csv downloaded from https://github.com/washingtonpost/data-homicides

```{r}
homicides <- read_csv("./data/homicide-data.csv")
```

See first few lines of data to see what's there
```{r}
head(homicides)
```

Unite the city and state columns to make a general location column
Remove Tulsa, AL because does not exist and skews data
```{r}

homicides <- homicides %>%
  unite(col = "location", c("city", "state"),
        sep = ", ") %>%
  filter(location !="Tulsa, AL")

```

**Key for myself**
**unsolved = closed without arrest or open/no arrest**

Create new dataframe with unsolved cases info
Select only necessary columns
Make a new True/False column for unsolved cases
Group by the location and summarize the number of unsolved and the total cases

```{r}
unsolved_df <- homicides %>%
  select(location, disposition) %>%
  mutate(unsolved = disposition != "Closed by arrest") %>%
  group_by(location) %>%
  summarise(total_cases = n(), unsolved = sum(unsolved))

head(unsolved2)

```

Create new dataframe with only data for Baltimore
Perform proportion test on Baltimore cases
Tidy prop_test data 

```{r}
Baltimore_df <- unsolved_df %>%
  filter(location == "Baltimore, MD")

Baltimore_prop_test <- prop.test(x= Baltimore_df$unsolved, 
                                  n = Baltimore_df$total_cases)

tidy(Baltimore_prop_test)
```


**Now use what you learned from running prop.test for one city to run prop.test for all the cities. Your goal is to create the figure shown below, where the points show the estimated proportions of unsolved homicides in each city and the horizontal lines show the estimated 95% confidence intervals. Do this all within a “tidy” pipeline, starting from the unsolved dataframe that you created for step 3. Use map2 from purrr to apply prop.test within each city and then map from purrr to apply tidy to this output. Use the unnest function from the tidyr package on the resulting list-column (from mapping tidy to the prop.test output list-column), with the option .drop = TRUE, to get your estimates back into a regular tidy data frame before plotting.**

Find total numbers by location

unest will take out numbers to expand to 1 row
```{r fig.width = 4.5, fig.height = 7}


tidy_cities_prop <- unsolved2 %>%
  mutate(my_prop_test = map2(unsolved, sum, prop.test),
         tidy_prop_test = map(my_prop_test, tidy)) %>%
  unnest(tidy_prop_test, .drop = TRUE) %>%
  arrange(desc(estimate)) %>%
  mutate(location = factor(location, levels = location[order(estimate)]))
  

tidy_cities_prop %>%
ggplot(aes(estimate, location)) +
  geom_point( color = "white") +
  geom_errorbarh(aes(xmin = conf.low, 
                     xmax = conf.high, 
                     height = 0),  color = "white") +
  scale_x_continuous(labels= scales::percent) +
  ggtitle("Unsolved homicides by city", subtitle = "Bars show 95% confidence interval") +
  xlab("Percent of homicdes that are unsolved")+
  ylab("") +
  theme_dark()

```





  


